# Rate Limiting Configuration
# Protects against DoS and brute force attacks

# Define rate limit zones
# General zone: 20 requests per second per IP (generous for normal browsing)
limit_req_zone $binary_remote_addr zone=general:10m rate=20r/s;

# API zone: 10 requests per second per IP (sufficient for API calls)
limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;

# Strict zone: 1 request per 10 seconds per IP (for sensitive endpoints)
limit_req_zone $binary_remote_addr zone=strict:10m rate=6r/m;

# WebSocket zone: 5 connections per IP simultaneously
limit_conn_zone $binary_remote_addr zone=websocket:10m;

# Connection limits per IP
limit_conn_zone $binary_remote_addr zone=addr:10m;

# Request body size limit (already set globally, but can override)
client_body_buffer_size 16k;
client_header_buffer_size 1k;
large_client_header_buffers 4 8k;

# Timeouts to prevent slowloris attacks
client_body_timeout 12;
client_header_timeout 12;
send_timeout 10;

# Log rate limit rejections
limit_req_log_level warn;
limit_conn_log_level warn;

# Status code for rate limit rejections
limit_req_status 429;
limit_conn_status 429;
